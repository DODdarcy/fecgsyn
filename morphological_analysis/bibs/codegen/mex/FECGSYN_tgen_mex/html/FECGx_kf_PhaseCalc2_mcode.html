<pre class="code">
<span class="srcline"><span class="lineno"><a href="2,1" id="srcline1"> 1</a></span><span class="line"><span class="comment">%% Phase Calculation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% Generates the phase signal for Kalman Filtering</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% Inputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% peaks             QRS peak locations</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% length            Length of data for phase generation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="2,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="2,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% Fetal Extraction Toolbox, version 1.0, February 2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% Released under the GNU General Public License</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,10" id="srcline10">10</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,11" id="srcline11">11</a></span><span class="line"><span class="comment">% Copyright (C) 2014  Fernando Andreotti</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,12" id="srcline12">12</a></span><span class="line"><span class="comment">% Dresden University of Technology, Institute of Biomedical Engineering</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,13" id="srcline13">13</a></span><span class="line"><span class="comment">% fernando.andreotti@mailbox.tu-dresden.de</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,14" id="srcline14">14</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,15" id="srcline15">15</a></span><span class="line"><span class="comment">% Last updated : 24-07-2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,16" id="srcline16">16</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,17" id="srcline17">17</a></span><span class="line"><span class="comment">% Based on: Synthetic ECG model error</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,18" id="srcline18">18</a></span><span class="line"><span class="comment">% Open Source ECG Toolbox, version 2.0, March 2008</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,19" id="srcline19">19</a></span><span class="line"><span class="comment">% Released under the GNU General Public License</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,20" id="srcline20">20</a></span><span class="line"><span class="comment">% Copyright (C) 2008  Reza Sameni</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,21" id="srcline21">21</a></span><span class="line"><span class="comment">% Sharif University of Technology, Tehran, Iran -- LIS-INPG, Grenoble, France</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,22" id="srcline22">22</a></span><span class="line"><span class="comment">% reza.sameni@gmail.com</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,24" id="srcline24">24</a></span><span class="line"><span class="comment">% This program is free software; you can redistribute it and/or modify it</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,25" id="srcline25">25</a></span><span class="line"><span class="comment">% under the terms of the GNU General Public License as published by the</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,26" id="srcline26">26</a></span><span class="line"><span class="comment">% Free Software Foundation; either version 2 of the License, or (at your</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,27" id="srcline27">27</a></span><span class="line"><span class="comment">% option) any later version.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,28" id="srcline28">28</a></span><span class="line"><span class="comment">% This program is distributed in the hope that it will be useful, but</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,29" id="srcline29">29</a></span><span class="line"><span class="comment">% WITHOUT ANY WARRANTY; without even the implied warranty of</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,30" id="srcline30">30</a></span><span class="line"><span class="comment">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,31" id="srcline31">31</a></span><span class="line"><span class="comment">% Public License for more details.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,32" id="srcline32">32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,33" id="srcline33">33</a></span><span class="line"><span class="comment">% This program is free software; you can redistribute it and/or modify it</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,34" id="srcline34">34</a></span><span class="line"><span class="comment">% under the terms of the GNU General Public License as published by the</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,35" id="srcline35">35</a></span><span class="line"><span class="comment">% Free Software Foundation; either version 2 of the License, or (at your</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,36" id="srcline36">36</a></span><span class="line"><span class="comment">% option) any later version.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,37" id="srcline37">37</a></span><span class="line"><span class="comment">% This program is distributed in the hope that it will be useful, but</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,38" id="srcline38">38</a></span><span class="line"><span class="comment">% WITHOUT ANY WARRANTY; without even the implied warranty of</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,39" id="srcline39">39</a></span><span class="line"><span class="comment">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,40" id="srcline40">40</a></span><span class="line"><span class="comment">% Public License for more details.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,41" id="srcline41">41</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,42" id="srcline42">42</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">phase</span> = FECGx_kf_PhaseCalc(<span class="var type1" id="S3T1U6">peaks</span>,<span class="var type1" id="S4T2U7">lengthx</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,43" id="srcline43">43</a></span><span class="line"><span class="comment">% Based on Sameni's method for phase calculation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,44" id="srcline44">44</a></span><span class="line"><span class="mxinfo " id="T1:U4"><span class="var type1" id="S2T1U10">phase</span> = <span class="mxinfo " id="T1:U6">zeros(<span class="mxinfo " id="T2:U7">1</span>,<span class="var type1" id="S4T2U14">lengthx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,45" id="srcline45">45</a></span><span class="line"><span class="mxinfo " id="T1:U9"><span class="var type1" id="S6T1U17">m</span> = <span class="mxinfo " id="T1:U11">diff(<span class="var type1" id="S3T1U20">peaks</span>)</span></span>;            <span class="comment">% gets distance between peaks</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,46" id="srcline46">46</a></span><span class="line"><span class="comment">% first interval</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,47" id="srcline47">47</a></span><span class="line"><span class="comment">% dealing with borders (first and last peaks may not be full waves)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,48" id="srcline48">48</a></span><span class="line"><span class="comment">% uses second interval as reference</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,49" id="srcline49">49</a></span><span class="line"><span class="mxinfo " id="T2:U13"><span class="var type1" id="S8T2U23">L</span> = <span class="mxinfo " id="T2:U15"><span class="var type1" id="S3T1U25">peaks</span>(<span class="mxinfo " id="T2:U17">1</span>)</span></span>;   <span class="comment">%length of first interval</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,50" id="srcline50">50</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T3:U18">isempty(<span class="var type1" id="S6T1U31">m</span>)</span> <span class="comment">% only ONE peak was detected</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,51" id="srcline51">51</a></span><span class="line">    <span class="mxinfo " id="T1:U20"><span class="mxinfo " id="T1:U21"><span class="var type1" id="S2T1U35">phase</span>(<span class="mxinfo " id="T2:U23">1</span>:<span class="var type1" id="S4T2U38">lengthx</span>)</span> = <span class="mxinfo " id="T1:U25">linspace(-2*pi,2*pi,<span class="var type1" id="S4T2U50">lengthx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,52" id="srcline52">52</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,53" id="srcline53">53</a></span><span class="line">    <span class="mxinfo " id="T1:U27"><span class="mxinfo " id="T1:U28"><span class="var type1" id="S2T1U55">phase</span>(<span class="mxinfo " id="T2:U30">1</span>:<span class="var type1" id="S8T2U58">L</span>)</span> = <span class="mxinfo " id="T1:U32">linspace(<span class="mxinfo " id="T2:U33"><span class="mxinfo " id="T2:U34"><span class="mxinfo " id="T2:U35">2</span>*<span class="mxinfo " id="T2:U36">pi</span></span>-<span class="mxinfo " id="T2:U37"><span class="mxinfo " id="T2:U38"><span class="mxinfo " id="T2:U39"><span class="var type1" id="S8T2U69">L</span>*<span class="mxinfo " id="T2:U41">2</span></span>*<span class="mxinfo " id="T2:U42">pi</span></span>/<span class="mxinfo " id="T2:U43"><span class="var type1" id="S6T1U74">m</span>(<span class="mxinfo " id="T2:U45">1</span>)</span></span></span>,2*pi,<span class="var type1" id="S8T2U80">L</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,54" id="srcline54">54</a></span><span class="line">    <span class="comment">% beats in the middle</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,55" id="srcline55">55</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S12T2U83">i</span> = <span class="mxinfo " id="T2:U48">1</span>:<span class="mxinfo " id="T2:U49"><span class="mxinfo " id="T2:U50">length(<span class="var type1" id="S3T1U89">peaks</span>)</span>-<span class="mxinfo " id="T2:U52">1</span></span>;  <span class="comment">% generate phases between 0 and 2pi for almos all peaks</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,56" id="srcline56">56</a></span><span class="line">        <span class="mxinfo " id="T1:U53"><span class="mxinfo " id="T1:U54"><span class="var type1" id="S2T1U94">phase</span>(<span class="mxinfo " id="T2:U56"><span class="var type1" id="S3T1U97">peaks</span>(<span class="var type1" id="S12T2U98">i</span>)</span>:<span class="mxinfo " id="T2:U59"><span class="var type1" id="S3T1U100">peaks</span>(<span class="mxinfo " id="T2:U61"><span class="var type1" id="S12T2U102">i</span>+<span class="mxinfo " id="T2:U63">1</span></span>)</span>)</span> = <span class="mxinfo " id="T1:U64">linspace(0,2*pi,<span class="mxinfo " id="T2:U65"><span class="mxinfo " id="T2:U66"><span class="var type1" id="S6T1U113">m</span>(<span class="var type1" id="S12T2U114">i</span>)</span>+<span class="mxinfo " id="T2:U69">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,57" id="srcline57">57</a></span><span class="line">    <span class="keyword">end</span>                                         <span class="comment">% 2pi is overlapped by 0 on every loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,58" id="srcline58">58</a></span><span class="line">    <span class="comment">% last interval</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,59" id="srcline59">59</a></span><span class="line">    <span class="comment">% uses second last interval as reference</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,60" id="srcline60">60</a></span><span class="line">    <span class="mxinfo " id="T2:U70"><span class="var type1" id="S8T2U118">L</span> = <span class="mxinfo " id="T2:U72"><span class="mxinfo " id="T2:U73">length(<span class="var type1" id="S2T1U122">phase</span>)</span>-<span class="mxinfo " id="T2:U75"><span class="var type1" id="S3T1U124">peaks</span>(<span class="mxinfo " id="T2:U77">end</span>)</span></span></span>;   <span class="comment">%length of last interval</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,61" id="srcline61">61</a></span><span class="line">    <span class="mxinfo " id="T1:U78"><span class="mxinfo " id="T1:U79"><span class="var type1" id="S2T1U130">phase</span>(<span class="mxinfo " id="T2:U81"><span class="var type1" id="S3T1U133">peaks</span>(<span class="mxinfo " id="T2:U83">end</span>)</span>:<span class="mxinfo " id="T2:U84">end</span>)</span> = <span class="mxinfo " id="T1:U85">linspace(0,<span class="mxinfo " id="T2:U86"><span class="mxinfo " id="T2:U87"><span class="mxinfo " id="T2:U88"><span class="var type1" id="S8T2U144">L</span>*<span class="mxinfo " id="T2:U90">2</span></span>*<span class="mxinfo " id="T2:U91">pi</span></span>/<span class="mxinfo " id="T2:U92"><span class="var type1" id="S6T1U149">m</span>(<span class="mxinfo " id="T2:U94">end</span>)</span></span>,<span class="mxinfo " id="T2:U95"><span class="var type1" id="S8T2U153">L</span>+<span class="mxinfo " id="T2:U97">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,62" id="srcline62">62</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,63" id="srcline63">63</a></span><span class="line"><span class="mxinfo " id="T1:U98"><span class="var type1" id="S2T1U157">phase</span> = <span class="mxinfo " id="T1:U100">mod(<span class="var type1" id="S2T1U160">phase</span>,2*pi)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,64" id="srcline64">64</a></span><span class="line"><span class="mxinfo " id="T1:U102"><span class="mxinfo " id="T1:U103"><span class="var type1" id="S2T1U168">phase</span>(<span class="mxinfo " id="T1:U105">find(<span class="mxinfo " id="T19:U106"><span class="var type1" id="S2T1U172">phase</span>&gt;<span class="mxinfo " id="T2:U108">pi</span></span>)</span>)</span> = <span class="mxinfo " id="T1:U109"><span class="mxinfo " id="T1:U110"><span class="var type1" id="S2T1U177">phase</span>(<span class="mxinfo " id="T1:U112">find(<span class="mxinfo " id="T19:U113"><span class="var type1" id="S2T1U181">phase</span>&gt;<span class="mxinfo " id="T2:U115">pi</span></span>)</span>)</span>- <span class="mxinfo " id="T2:U116"><span class="mxinfo " id="T2:U117">2</span>*<span class="mxinfo " id="T2:U118">pi</span></span></span></span>;</span></span>
</pre>
