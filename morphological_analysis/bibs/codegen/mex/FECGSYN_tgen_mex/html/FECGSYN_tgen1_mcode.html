<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T65U3">template</span>,<span class="var type1" id="S3T65U4">qrsloc</span>,<span class="var type1" id="S4T65U5">status</span>] = FECGSYN_tgen(<span class="var type1" id="S5T1U8">ecg</span>,<span class="var type1" id="S6T1U9">qrs</span>,<span class="var type1" id="S7T2U10">fs</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% this function is used to contruct a template ecg based on the location of</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% the R-peaks. A series of peaks that match with each other are stacked to</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% build a template. This template can then be used for ecg morphological</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% analysis or further processing. Note that the qrs location inputed must</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% be as precise as possible. This approach for building the template ECG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% seems to be the best of the alternatives that were tested and leaves the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% freedom of having more than one mode (i.e. multiple ECG template can be</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% built if there are different cycle morphology such as PVC)  but it is not</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% particularly fast.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% The procedure for building the template is:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% 1. create average wrapped template</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% 2. identify different modes present</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% inputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">%   ecg:            the ecg channel(s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">%   qrs:            qrs location [number of samples]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%    fs:            sampling frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% outputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%   relevantMode:   structure containing cycle, cycleMean and cycleStd</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%                   representing how many cycles have been selected to build the stack, the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%                   mean ecg cycle that is built upon these selected cycles and the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%                   standard deviation for each point of the template cycle as an indicator</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">%                   of the precision of the estimation. *Only the dominant mode is outputted</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">%                   for this application.*</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%   status:         bool, success or failed to extract a dominant mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% Dependencies: FECGSYN_phase_wrap.m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">% inputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%   ecg:     ecg signal</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%   qrs:     qrs fiducials</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">%   phase:   phase of the EGC</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%   bins:    number of bins for the phase wrapping</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%   fs:      sampling frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%   flag:    adjust 'iso' to zero</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">%   debug:   debug level (1/2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% outputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">%   ecgme:   template ECG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">%   ecgsd:   ECG standard deviation used as a proxy of signal quality</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">%            (i.e. trust of the Kalman in observations)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">%   phaseme: mean phase of the template ECG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%   nbcyc:   number of cycles used to build the template</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">% Dual EKF, version 1.0, March 2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">% Released under the GNU General Public License</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">% Copyright (C) 2014  Joachim Behar</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% Oxford university, Intelligent Patient Monitoring Group</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">% joachim.behar@eng.ox.ac.uk</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">% Last updated : 07-07-2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">% This function is adapted from the OSET toolbox of Dr Reza Sameni</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">% This program is free software; you can redistribute it and/or modify it</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% under the terms of the GNU General Public License as published by the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">% Free Software Foundation; either version 2 of the License, or (at your</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">% option) any later version.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">% This program is distributed in the hope that it will be useful, but</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">% WITHOUT ANY WARRANTY; without even the implied warranty of</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="comment">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Public License for more details.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S8T0U12">debug</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">% == manage inputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="keyword">if</span> nargin&lt;2; error(<span class="string">'ecg_template_build: wrong number of input arguments \n'</span>); <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">% == constants</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="var type1" id="S11T2U25">NB_BINS</span> = 250; <span class="comment">% number of beans onto which to wrap a cycle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="var type1" id="S12T2U29">NB_LEADS</span> = size(<span class="var type1" id="S5T1U32">ecg</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="var type1" id="S14T2U36">NB_SAMPLES</span> = size(<span class="var type1" id="S5T1U39">ecg</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="var type0" id="S15T0U43">NB_REL</span> = 10; <span class="comment">% number relevance. How many cycles minimum to consider that a mode is relevant? - UPDATE ME DEPENDING ON APPLICATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="var type1" id="S16T2U47">MIN_NB_CYC</span> = 30; <span class="comment">% mininum number of cycles (will decrease THRES until this number of cycles is achieved) - UPDATE ME DEPENDING ON APPLICATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="var type1" id="S17T2U51">THRES</span> = 0.9; <span class="comment">% threshold at which to decide whether the cycle match or not - UPDATE ME DEPENDING ON APPLICATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="var type0" id="S18T0U55">MIN_TLEN</span> = 0.35;     <span class="comment">% minimum template length in ms - UPDATE ME DEPENDING ON APPLICATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="var type0" id="S19T0U59">PACE</span> = 0.05;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="var type1" id="S20T2U63">MIN_THRES</span> = 0.6;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="var type1" id="S21T28U67">cycle</span> = zeros(<span class="var type1" id="S12T2U70">NB_LEADS</span>,<span class="var type1" id="S11T2U71">NB_BINS</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="var type1" id="S23T2U74">startCycle</span> = 2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="var type1" id="S24T2U78">NbModes</span> = 1; <span class="comment">% initialisation variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="var type0" id="S25T0U82">relevantModeInd</span> = []; <span class="comment">% - UPDATE ME DEPENDING ON APPLICATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="var type1" id="S26T64U88">relevantMode</span>.NbCycles = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">% == linear phase wrapping (shift in -pi/6)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="var type1" id="S27T1U93">phase</span> = <span class="fcn" id="F2N3:B95">FECGx_kf_PhaseCalc</span>(<span class="var type1" id="S6T1U96">qrs</span>,<span class="var type1" id="S14T2U97">NB_SAMPLES</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="var type1" id="S29T1U100">PhaseChangePoints</span> = find(<span class="var type1" id="S27T1U106">phase</span>(2:end)&lt;0&amp;<span class="var type1" id="S27T1U114">phase</span>(1:end-1)&gt;0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="var type1" id="S32T2U124">NB_CYCLES</span> = length(<span class="var type1" id="S29T1U127">PhaseChangePoints</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="comment">% ==== core function ====</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">% == creating the different modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="var type1" id="S34T1U130">cycleIndex</span> = (<span class="var type1" id="S29T1U135">PhaseChangePoints</span>(<span class="var type1" id="S23T2U136">startCycle</span>)+1:<span class="var type1" id="S29T1U139">PhaseChangePoints</span>(<span class="var type1" id="S23T2U141">startCycle</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S35T2U145">j</span>=1:<span class="var type1" id="S12T2U148">NB_LEADS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">    <span class="var type1" id="S21T28U152">cycle</span>(<span class="var type1" id="S35T2U153">j</span>,:) = interp1(<span class="var type1" id="S27T1U158">phase</span>(<span class="var type1" id="S34T1U159">cycleIndex</span>),<span class="var type1" id="S5T1U161">ecg</span>(<span class="var type1" id="S35T2U162">j</span>,<span class="var type1" id="S34T1U163">cycleIndex</span>),linspace(-pi,pi,<span class="var type1" id="S11T2U171">NB_BINS</span>),<span class="string">'spline'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="var type0" id="S39T0U177"><span class="message error" id="M1F1C">Mode</span></span>{<span class="var type0" id="S24T0U178">NbModes</span>}.cycles = zeros(<span class="var type1" id="S12T2U182">NB_LEADS</span>,<span class="var type1" id="S11T2U183">NB_BINS</span>,1);       <span class="comment">% cycles included</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="var type0" id="S39T0U190"><span class="message error" id="M2F1C">Mode</span></span>{<span class="var type0" id="S24T0U191">NbModes</span>}.cycles(:,:,1) = <span class="var type1" id="S21T28U196">cycle</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="var type0" id="S39T0U201"><span class="message error" id="M3F1C">Mode</span></span>{<span class="var type0" id="S24T0U202">NbModes</span>}.cycleMean = <span class="var type1" id="S21T28U204">cycle</span>;                        <span class="comment">% average cycle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="var type0" id="S39T0U209"><span class="message error" id="M4F1C">Mode</span></span>{<span class="var type0" id="S24T0U210">NbModes</span>}.cycleStd = zeros(3,<span class="var type1" id="S11T2U215">NB_BINS</span>);              <span class="comment">% standard deviation from cycles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="var type0" id="S39T0U220"><span class="message error" id="M5F1C">Mode</span></span>{<span class="var type0" id="S24T0U221">NbModes</span>}.NbCycles = 1;                             <span class="comment">% number of cycles present</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="var type0" id="S39T0U228"><span class="message error" id="M6F1C">Mode</span></span>{<span class="var type0" id="S24T0U229">NbModes</span>}.cycleLen = [];                            <span class="comment">% length of cycles (in samples)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="keyword">while</span> <span class="var type1" id="S26T64U237">relevantMode</span>.NbCycles&lt;<span class="var type1" id="S16T2U239">MIN_NB_CYC</span> &amp;&amp; <span class="var type1" id="S17T2U241">THRES</span>&gt;<span class="var type1" id="S20T2U242">MIN_THRES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">    <span class="comment">% the THRES is lowered until a mode with mode than MIN_NB_CYC cycles is</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">    <span class="comment">% detected or the THREShold is too low (which means no mode can be identified)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S40T2U245">i</span>=<span class="var type1" id="S23T2U248">startCycle</span>+1:<span class="var type1" id="S32T2U251">NB_CYCLES</span>-2</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">        <span class="var type1" id="S34T1U255">cycleIndex</span> = (<span class="var type1" id="S29T1U260">PhaseChangePoints</span>(<span class="var type1" id="S40T2U261">i</span>)+1:<span class="var type1" id="S29T1U264">PhaseChangePoints</span>(<span class="var type1" id="S40T2U266">i</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S35T2U270">j</span>=1:<span class="var type1" id="S12T2U273">NB_LEADS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">            <span class="var type1" id="S21T28U277">cycle</span>(<span class="var type1" id="S35T2U278">j</span>,:) = interp1(<span class="var type1" id="S27T1U283">phase</span>(<span class="var type1" id="S34T1U284">cycleIndex</span>),<span class="var type1" id="S5T1U286">ecg</span>(<span class="var type1" id="S35T2U287">j</span>,<span class="var type1" id="S34T1U288">cycleIndex</span>),linspace(-pi,pi,<span class="var type1" id="S11T2U296">NB_BINS</span>),<span class="string">'spline'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">        <span class="var type1" id="S41T2U300">match</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">        <span class="var type1" id="S42T2U304">indMode</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">        <span class="keyword">while</span> (~<span class="var type1" id="S41T2U310">match</span>&amp;&amp;<span class="var type1" id="S42T2U312">indMode</span>&lt;=<span class="var type1" id="S24T2U313">NbModes</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">            [<span class="var type0" id="S43T0U317"><span class="message error" id="M8F1C">r</span></span>,<span class="message error" id="M9F1C">~</span>] = corrcoef(<span class="var type1" id="S21T28U321">cycle</span>,<span class="var type0" id="S39T0U324"><span class="message error" id="M7F1C">Mode</span></span>{<span class="var type0" id="S42T0U325">indMode</span>}.cycleMean);</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">            <span class="var type0" id="S45T0U329">coeff</span> = abs(<span class="var type0" id="S43T0U333"><span class="message error" id="M10F1C">r</span></span>(1,2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">            <span class="var type0" id="S41T0U338">match</span> = <span class="var type0" id="S45T0U340"><span class="message error" id="M11F1C">coeff</span></span>&gt;<span class="var type0" id="S17T0U341">THRES</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">            <span class="var type1" id="S42T2U344">indMode</span> = <span class="var type1" id="S42T2U346">indMode</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">        <span class="keyword">if</span> ~<span class="var type1" id="S41T2U351">match</span>  <span class="comment">% if the new cycle does not match with the average cycle of any mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">            <span class="comment">% then create a new mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">            <span class="var type1" id="S24T2U354">NbModes</span>=<span class="var type1" id="S24T2U356">NbModes</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">            <span class="var type0" id="S39T0U362"><span class="message error" id="M12F1C">Mode</span></span>{<span class="var type0" id="S24T0U363">NbModes</span>}.cycles = zeros(<span class="var type1" id="S12T2U367">NB_LEADS</span>,<span class="var type1" id="S11T2U368">NB_BINS</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">            <span class="var type0" id="S39T0U375"><span class="message error" id="M13F1C">Mode</span></span>{<span class="var type0" id="S24T0U376">NbModes</span>}.cycles(:,:,1) = <span class="var type1" id="S21T28U381">cycle</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">            <span class="var type0" id="S39T0U386"><span class="message error" id="M14F1C">Mode</span></span>{<span class="var type0" id="S24T0U387">NbModes</span>}.cycleMean = <span class="var type1" id="S21T28U389">cycle</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">            <span class="var type0" id="S39T0U394"><span class="message error" id="M15F1C">Mode</span></span>{<span class="var type0" id="S24T0U395">NbModes</span>}.cycleStd = zeros(3,<span class="var type1" id="S11T2U400">NB_BINS</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">            <span class="var type0" id="S39T0U405"><span class="message error" id="M16F1C">Mode</span></span>{<span class="var type0" id="S24T0U406">NbModes</span>}.NbCycles = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">            <span class="var type0" id="S39T0U413"><span class="message error" id="M17F1C">Mode</span></span>{<span class="var type0" id="S24T0U414">NbModes</span>}.cycleLen = length(<span class="var type1" id="S34T1U418">cycleIndex</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">        <span class="keyword">else</span> <span class="comment">% it it correlates then integrate it to the corresponding mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">            <span class="var type0" id="S39T0U424">Mode</span>{<span class="var type0" id="S42T0U426">indMode</span>-1}.NbCycles = <span class="var type0" id="S39T0U432"><span class="message error" id="M18F1C">Mode</span></span>{<span class="var type0" id="S42T0U434">indMode</span>-1}.NbCycles+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">            <span class="var type0" id="S47T0U440">temp</span> = <span class="var type0" id="S39T0U443"><span class="message error" id="M19F1C">Mode</span></span>{<span class="var type0" id="S42T0U445">indMode</span>-1}.cycles ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">            <span class="var type0" id="S39T0U452">Mode</span>{<span class="var type0" id="S42T0U454">indMode</span>-1}.cycles = zeros(<span class="var type1" id="S12T2U459">NB_LEADS</span>,<span class="var type1" id="S11T2U460">NB_BINS</span>,<span class="var type0" id="S39T0U463"><span class="message error" id="M20F1C">Mode</span></span>{<span class="var type0" id="S42T0U465">indMode</span>-1}.NbCycles);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">            <span class="var type0" id="S39T0U473">Mode</span>{<span class="var type0" id="S42T0U475">indMode</span>-1}.cycles(:,:,1:end-1)= <span class="var type0" id="S47T0U486"><span class="message error" id="M21F1C">temp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">            <span class="var type0" id="S39T0U492"><span class="message error" id="M22F1C">Mode</span></span>{<span class="var type0" id="S42T0U494">indMode</span>-1}.cycles(:,:,end)= <span class="var type1" id="S21T28U501">cycle</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">            <span class="var type0" id="S39T0U506">Mode</span>{<span class="var type0" id="S42T0U508">indMode</span>-1}.cycleMean = mean(<span class="var type0" id="S39T0U515"><span class="message error" id="M23F1C">Mode</span></span>{<span class="var type0" id="S42T0U517">indMode</span>-1}.cycles,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">            <span class="var type0" id="S39T0U525">Mode</span>{<span class="var type0" id="S42T0U527">indMode</span>-1}.cycleStd = std(<span class="var type0" id="S39T0U534"><span class="message fatal" id="M24F1C">Mode</span></span>{<span class="var type0" id="S42T0U536">indMode</span>-1}.cycles,0,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">            <span class="var type0" id="S39T0U545">Mode</span>{<span class="var type0" id="S42T0U547">indMode</span>-1}.cycleLen = [<span class="var type0" id="S39T0U554">Mode</span>{<span class="var type0" id="S42T0U556">indMode</span>-1}.cycleLen length(<span class="var type0" id="S34T0U561">cycleIndex</span>)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="comment">% == detecting what mode is relevant</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S40T0U564">i</span>=1:length(<span class="var type0" id="S39T0U569">Mode</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">        <span class="comment">% minimum amount of cycles and length</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">        <span class="keyword">if</span> <span class="var type0" id="S39T0U576">Mode</span>{<span class="var type0" id="S40T0U577">i</span>}.NbCycles&gt;<span class="var type0" id="S15T0U579">NB_REL</span> &amp;&amp; mean(<span class="var type0" id="S39T0U585">Mode</span>{<span class="var type0" id="S40T0U586">i</span>}.cycleLen) &gt;= <span class="var type0" id="S18T0U589">MIN_TLEN</span>*<span class="var type0" id="S7T0U590">fs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">            <span class="var type0" id="S25T0U593">relevantModeInd</span> = [<span class="var type0" id="S25T0U596">relevantModeInd</span> <span class="var type0" id="S40T0U597">i</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    <span class="var type0" id="S26T0U600">relevantMode</span> = <span class="var type0" id="S39T0U602">Mode</span>(<span class="var type0" id="S25T0U603">relevantModeInd</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type0" id="S26T0U608">relevantMode</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">        <span class="comment">% if we did not catch anything then output rubbish</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="var type0" id="S26T0U612">relevantMode</span>.cycleMean = ones(<span class="var type0" id="S11T0U616">NB_BINS</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">        <span class="var type0" id="S26T0U621">relevantMode</span>.cycleStd = ones(<span class="var type0" id="S11T0U625">NB_BINS</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">        <span class="var type0" id="S26T0U630">relevantMode</span>.NbCycles  = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">        <span class="var type0" id="S26T0U636">relevantMode</span>.cycleLen = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">        <span class="var type0" id="S4T0U641">status</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">        <span class="var type0" id="S2T0U646">template</span>.avg = NaN;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">        <span class="var type0" id="S2T0U653">template</span>.stdev = NaN;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">        <span class="var type0" id="S3T0U659">qrsloc</span> = NaN;</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">        <span class="var type0" id="S53T0U665">relevantModeStruc</span> = [<span class="var type0" id="S26T0U669">relevantMode</span>{:}];</span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">        [~,<span class="var type0" id="S54T0U675">pos</span>] = max([<span class="var type0" id="S53T0U681">relevantModeStruc</span>.NbCycles]); <span class="comment">% look for dominant mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">        <span class="var type0" id="S26T0U685">relevantMode</span> = <span class="var type0" id="S26T0U687">relevantMode</span>{<span class="var type0" id="S54T0U688">pos</span>}; <span class="comment">% only return the dominant mode for this application</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">        <span class="var type0" id="S4T0U691">status</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">        <span class="comment">% == Converting template from bins back to samples</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">        <span class="var type0" id="S56T0U695">desl</span> = round(<span class="var type0" id="S11T0U699">NB_BINS</span>/6);</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">        <span class="var type0" id="S2T0U704">template</span>.avg = circshift(<span class="var type0" id="S26T0U710">relevantMode</span>.cycleMean',-<span class="var type0" id="S56T0U713">desl</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">        <span class="var type0" id="S2T0U717">template</span>.stdev = circshift(<span class="var type0" id="S26T0U723">relevantMode</span>.cycleStd',-<span class="var type0" id="S56T0U726">desl</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">        <span class="var type0" id="S2T0U730">template</span>.avg = resample(<span class="var type0" id="S2T0U735">template</span>.avg,round(mean(<span class="var type0" id="S26T0U742">relevantMode</span>.cycleLen)),<span class="var type0" id="S11T0U744">NB_BINS</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">        <span class="var type0" id="S2T0U748">template</span>.stdev = resample(<span class="var type0" id="S2T0U754">template</span>.avg,round(mean(<span class="var type0" id="S26T0U761">relevantMode</span>.cycleLen)),<span class="var type0" id="S11T0U763">NB_BINS</span>)';</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">        <span class="var type0" id="S3T0U766">qrsloc</span> = round(round((<span class="var type0" id="S11T0U775">NB_BINS</span>/2 - <span class="var type0" id="S56T0U777">desl</span>)*(length(<span class="var type0" id="S2T0U783">template</span>.avg)/<span class="var type0" id="S11T0U785">NB_BINS</span>)));</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">        [~,<span class="var type0" id="S60T0U790">delay</span>]=max(abs(<span class="var type0" id="S2T0U796">template</span>.avg));</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">        <span class="keyword">if</span> abs(<span class="var type0" id="S3T0U804">qrsloc</span>-<span class="var type0" id="S60T0U805">delay</span>)&lt;3, <span class="var type0" id="S3T0U809">qrsloc</span> = <span class="var type0" id="S60T0U810">delay</span>; <span class="keyword">end</span>  <span class="comment">% allow some alignment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    <span class="var type0" id="S17T0U813">THRES</span> = <span class="var type0" id="S17T0U815">THRES</span>-<span class="var type0" id="S19T0U816">PACE</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="keyword">if</span> <span class="var type0" id="S8T0U819">debug</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    fprintf(<span class="string">'The number of cycles constituting the dominant mode was %f \n'</span>,<span class="var type0" id="S26T0U825">relevantMode</span>.NbCycles);</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    fprintf(<span class="string">'The correlation threshold at which this happened was    %f \n'</span>,<span class="var type0" id="S17T0U832">THRES</span>+<span class="var type0" id="S19T0U833">PACE</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    fprintf(<span class="string">'========================================================== \n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
